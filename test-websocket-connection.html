<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Connection Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      .online {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .offline {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .loading {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .connect {
        background-color: #28a745;
        color: white;
      }
      .disconnect {
        background-color: #dc3545;
        color: white;
      }
      .test {
        background-color: #007bff;
        color: white;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Connection Test</h1>

    <div>
      <label for="userId">User ID:</label>
      <input type="number" id="userId" value="1" min="1" />
      <button class="connect" onclick="connect()">Connect</button>
      <button class="disconnect" onclick="disconnect()">Disconnect</button>
    </div>

    <div>
      <h3>Connection Status:</h3>
      <div id="connectionStatus" class="status loading">Disconnected</div>
    </div>

    <div>
      <h3>WebSocket Messages:</h3>
      <div id="messages" class="log"></div>
    </div>

    <div>
      <button class="test" onclick="testPing()">Test Ping</button>
      <button class="test" onclick="clearLog()">Clear Log</button>
    </div>

    <script>
      let ws = null;
      let userId = 1;

      function log(message) {
        const messagesEl = document.getElementById("messages");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.textContent = `[${timestamp}] ${message}`;
        messagesEl.appendChild(logEntry);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function connect() {
        userId = parseInt(document.getElementById("userId").value);
        if (ws) disconnect();

        const wsUrl = `ws://localhost:3001/ws-online-status?userId=${userId}`;
        log(`🔗 Attempting to connect to: ${wsUrl}`);

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          updateConnectionStatus("Connected", "online");
          log("✅ WebSocket connected successfully");
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          log(`📨 Received: ${JSON.stringify(message, null, 2)}`);
        };

        ws.onclose = (event) => {
          updateConnectionStatus("Disconnected", "offline");
          log(`🔌 WebSocket closed: ${event.code} - ${event.reason}`);
        };

        ws.onerror = (error) => {
          updateConnectionStatus("Error", "offline");
          log(`❌ WebSocket error: ${error}`);
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
          log("🔌 Manually disconnected");
        }
      }

      function testPing() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.ping();
          log("🏓 Ping sent");
        } else {
          log("❌ Not connected - cannot ping");
        }
      }

      function clearLog() {
        document.getElementById("messages").innerHTML = "";
      }

      function updateConnectionStatus(text, className) {
        const statusEl = document.getElementById("connectionStatus");
        statusEl.textContent = text;
        statusEl.className = `status ${className}`;
      }

      // Auto-connect on page load
      window.onload = () => {
        log("🚀 Page loaded, ready to test WebSocket connection");
      };
    </script>
  </body>
</html>
